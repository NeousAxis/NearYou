(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))a(o);new MutationObserver(o=>{for(const i of o)if(i.type==="childList")for(const c of i.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&a(c)}).observe(document,{childList:!0,subtree:!0});function n(o){const i={};return o.integrity&&(i.integrity=o.integrity),o.referrerPolicy&&(i.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?i.credentials="include":o.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function a(o){if(o.ep)return;o.ep=!0;const i=n(o);fetch(o.href,i)}})();const m={fr:{heroTitle:"Trouvez ce que<br>vous cherchez.",heroSubtitle:"Scannez n'importe quel objet pour d√©couvrir les meilleures adresses autour de vous.",analyzing:"Analyse intelligente...",nearby:"√Ä proximit√©",sortDistance:"Proche",sortPrice:"Prix",detected:"D√©tect√© :",newSearch:"Nouvelle recherche",alertGeo:"üìç Veuillez autoriser la g√©olocalisation dans R√©glages ‚Üí Safari ‚Üí Position",alertError:"‚ùå Une erreur s'est produite. Veuillez r√©essayer.",choiceTitle:"Que cherchez-vous ?",choiceDetected:"Nous avons d√©tect√© :",categories:{"Fournitures de bureau":"Fournitures de bureau",Alimentation:"Alimentation"}},en:{heroTitle:"Find what<br>you need.",heroSubtitle:"Scan any object to discover the best places around you.",analyzing:"Smart analyzing...",nearby:"Nearby",sortDistance:"Closest",sortPrice:"Price",detected:"Detected:",newSearch:"New Search",alertGeo:"üìç Please allow location access in Settings ‚Üí Safari ‚Üí Location",alertError:"‚ùå An error occurred. Please try again.",choiceTitle:"What are you looking for?",choiceDetected:"We detected:",categories:{"Fournitures de bureau":"Office Supplies",Alimentation:"Food & Drink"}},vi:{heroTitle:"T√¨m nh·ªØng g√¨<br>b·∫°n c·∫ßn.",heroSubtitle:"Qu√©t b·∫•t k·ª≥ ƒë·ªì v·∫≠t n√†o ƒë·ªÉ kh√°m ph√° nh·ªØng ƒë·ªãa ƒëi·ªÉm t·ªët nh·∫•t xung quanh b·∫°n.",analyzing:"ƒêang ph√¢n t√≠ch...",nearby:"G·∫ßn ƒë√¢y",sortDistance:"G·∫ßn nh·∫•t",sortPrice:"Gi√°",detected:"ƒê√£ ph√°t hi·ªán:",newSearch:"T√¨m ki·∫øm m·ªõi",alertGeo:"Vui l√≤ng cho ph√©p ƒë·ªãnh v·ªã.",choiceTitle:"B·∫°n ƒëang t√¨m ki·∫øm g√¨?",choiceDetected:"Ch√∫ng t√¥i ƒë√£ ph√°t hi·ªán:",categories:{"Fournitures de bureau":"VƒÉn ph√≤ng ph·∫©m",Alimentation:"Th·ª±c ph·∫©m & ƒê·ªì u·ªëng"}},es:{heroTitle:"Encuentra lo que<br>buscas.",heroSubtitle:"Escanea cualquier objeto para descubrir los mejores lugares a tu alrededor.",analyzing:"Analizando...",nearby:"Cerca de ti",sortDistance:"Cercan√≠a",sortPrice:"Precio",detected:"Detectado:",newSearch:"Nueva b√∫squeda",alertGeo:"Por favor permite la geolocalizaci√≥n.",choiceTitle:"¬øQu√© est√°s buscando?",choiceDetected:"Detectamos:",categories:{"Fournitures de bureau":"Art√≠culos de oficina",Alimentation:"Alimentaci√≥n"}},de:{heroTitle:"Finde, was<br>du suchst.",heroSubtitle:"Scanne ein Objekt, um die besten Orte in deiner N√§he zu entdecken.",analyzing:"Analysieren...",nearby:"In der N√§he",sortDistance:"Entfernung",sortPrice:"Preis",detected:"Erkannt:",newSearch:"Neue Suche",alertGeo:"Bitte Standortfreigabe aktivieren.",choiceTitle:"Wonach suchst du?",choiceDetected:"Wir haben erkannt:",categories:{"Fournitures de bureau":"B√ºrobedarf",Alimentation:"Lebensmittel"}},it:{heroTitle:"Trova ci√≤ che<br>cerchi.",heroSubtitle:"Scansiona qualsiasi oggetto per scoprire i posti migliori intorno a te.",analyzing:"Analisi in corso...",nearby:"Nelle vicinanze",sortDistance:"Vicinanza",sortPrice:"Prezzo",detected:"Rilevato:",newSearch:"Nuova ricerca",alertGeo:"Si prega di consentire la geolocalizzazione.",choiceTitle:"Cosa stai cercando?",choiceDetected:"Abbiamo rilevato:",categories:{"Fournitures de bureau":"Forniture per ufficio",Alimentation:"Alimentari"}}},r={userLocation:null,sortBy:"distance",results:[],detectedCategory:null,language:q(),pendingAnalysis:null},f=document.getElementById("file-input"),B=document.getElementById("scan-btn"),$=document.getElementById("logo-btn"),y=document.getElementById("search-view"),b=document.getElementById("loading-view"),v=document.getElementById("choice-view"),w=document.getElementById("results-view"),g=document.getElementById("results-grid"),D=document.getElementById("reset-btn"),L=document.querySelectorAll(".chip"),S=document.getElementById("detected-badge"),E=document.getElementById("detected-label"),I=document.getElementById("lang-select"),F=document.getElementById("detected-item"),x=document.getElementById("choice-btn-1"),C=document.getElementById("choice-btn-2");I.value=r.language;k(r.language);B.addEventListener("click",()=>f.click());$.addEventListener("click",()=>h("search"));function q(){const t=localStorage.getItem("nearyou_lang");return t&&m[t]?t:"en"}function k(t){r.language=t,localStorage.setItem("nearyou_lang",t);const e=m[t];if(document.querySelectorAll("[data-i18n]").forEach(n=>{const a=n.dataset.i18n;e[a]&&(n.innerHTML=e[a])}),r.detectedCategory){const n=m[t].categories[r.detectedCategory]||r.detectedCategory;E.textContent=n}}function N(t){return"‚Ç¨".repeat(t)}function A(){if(g.innerHTML="",r.detectedCategory){const e=r.language,n=m[e].categories[r.detectedCategory]||r.detectedCategory;E.textContent=n,S.classList.remove("hidden")}else S.classList.add("hidden");let t=[...r.results];if(r.sortBy==="distance"?t.sort((e,n)=>e.distance-n.distance):r.sortBy==="price"&&t.sort((e,n)=>e.price-n.price),t.length===0){const{latitude:e,longitude:n}=r.userLocation,a=`https://www.google.com/maps?q=${e},${n}`;g.innerHTML=`
      <div class="no-results">
        <p>Aucun lieu trouv√© pour "${r.actualSearchTerm||r.detectedCategory}".</p>
        <div style="font-size: 12px; color: #666; margin-top: 10px; text-align: left; background: #f5f5f5; padding: 10px; border-radius: 8px;">
            <p><strong>Debug Info:</strong></p>
            <p>üìç Position: <a href="${a}" target="_blank" style="color: blue; text-decoration: underline;">${e.toFixed(5)}, ${n.toFixed(5)}</a> (Cliquez pour v√©rifier)</p>
            <p>üîç Recherche: ${r.actualSearchTerm||"G√©n√©rique"}</p>
            <p>üìÇ Cat√©gorie: ${r.detectedCategory||"Inconnue"}</p>
            <p>üìè Rayon: 50 km</p>
        </div>
        <p class="sub" style="margin-top: 15px;">Essayez une autre recherche ou √©largissez la zone.</p>
      </div>
    `;return}if(g.innerHTML="",r.fallbackInfo&&r.fallbackInfo.tier>1&&r.fallbackInfo.message){const e=document.createElement("div");e.style.cssText="background: #fff3cd; border-left: 4px solid #ffc107; padding: 12px; margin-bottom: 20px; border-radius: 8px; grid-column: 1 / -1;",e.innerHTML=`<p style="margin: 0; color: #856404; font-size: 14px;">‚ÑπÔ∏è ${r.fallbackInfo.message}</p>`,g.appendChild(e)}if(t.forEach((e,n)=>{const a=`https://www.google.com/maps/dir/?api=1&destination=${e.lat},${e.lng}`,o=document.createElement("div");if(o.className="place-card",o.innerHTML=`
      <img src="${e.image}" alt="${e.name}" class="place-image">
      <div class="place-details">
        <div class="place-category">${e.category}</div>
        <div class="place-name">${e.name}</div>
        <div class="place-address">${e.address}</div>
        <div class="place-footer">
          <a href="${a}" target="_blank" class="place-distance" title="Voir l'itin√©raire">
            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
            ${e.distance.toFixed(1)} km
          </a>
          <div class="place-price">${N(e.price)}</div>
        </div>
      </div>
    `,g.appendChild(o),(n+1)%2===0&&n!==t.length-1){const i=document.createElement("div");i.className="place-card ad-card",i.innerHTML=`
        <div class="ad-label">Publicit√©</div>
        <ins class="adsbygoogle"
             style="display:block"
           data-ad-client="ca-pub-9057470154911774"
             data-ad-slot="9453283378"
             data-ad-format="auto"
             data-full-width-responsive="true"></ins>
        <script>(adsbygoogle = window.adsbygoogle || []).push({});<\/script>
      `,g.appendChild(i)}}),t.length===1){const e=document.createElement("div");e.className="place-card ad-card",e.innerHTML=`
      <div class="ad-label">Publicit√©</div>
      <ins class="adsbygoogle"
           style="display:block"
           data-ad-client="ca-pub-9057470154911774"
           data-ad-slot="9453283378"
           data-ad-format="auto"
           data-full-width-responsive="true"></ins>
      <script>(adsbygoogle = window.adsbygoogle || []).push({});<\/script>
    `,g.appendChild(e)}}function h(t){y.classList.add("hidden"),b.classList.add("hidden"),v.classList.add("hidden"),w.classList.add("hidden"),t==="search"?y.classList.remove("hidden"):t==="loading"?b.classList.remove("hidden"):t==="choice"?v.classList.remove("hidden"):t==="results"&&w.classList.remove("hidden")}I.addEventListener("change",t=>{k(t.target.value)});f.addEventListener("change",t=>{t.target.files&&t.target.files[0]&&G(t.target.files[0])});D.addEventListener("click",()=>{h("search"),f.value="",r.results=[],r.detectedCategory=null});L.forEach(t=>{t.addEventListener("click",()=>{L.forEach(e=>e.classList.remove("active")),t.classList.add("active"),r.sortBy=t.dataset.sort,A()})});async function G(t){var e,n;h("loading");try{console.log("Step 1: Getting location...");const a=await j(),{latitude:o,longitude:i}=a.coords;r.userLocation={latitude:o,longitude:i},console.log("‚úì Location obtained:",o,i);const c=document.getElementById("debug-coords");c&&(c.innerText=`Lat: ${o.toFixed(5)}, Lng: ${i.toFixed(5)}`),console.log("Step 2: Compressing image...");const l=await R(t);console.log("‚úì Image compressed"),console.log("Step 3: Converting to base64...");const d=await O(l);console.log("‚úì Image converted, size:",d.length),console.log("Step 4: Calling OpenAI API...");const u=await H(d,"image/jpeg");console.log("‚úì Analysis received:",u),r.pendingAnalysis=u,M(u)}catch(a){if(console.error("‚ùå Error details:",a),console.error("Error stack:",a.stack),a.code===1||(e=a.message)!=null&&e.includes("geolocation")||(n=a.message)!=null&&n.includes("location"))alert(m[r.language].alertGeo);else{const o=a.message||"Unknown error";alert(`${m[r.language].alertError}

Details: ${o}`)}h("search")}}function O(t){return new Promise((e,n)=>{const a=new FileReader;a.readAsDataURL(t),a.onload=()=>{const o=a.result.split(",")[1];e(o)},a.onerror=o=>n(o)})}function R(t,e=800,n=.8){return new Promise((a,o)=>{const i=new FileReader;i.readAsDataURL(t),i.onload=c=>{const l=new Image;l.src=c.target.result,l.onload=()=>{const d=document.createElement("canvas");let u=l.width,p=l.height;u>e&&(p=p*e/u,u=e),d.width=u,d.height=p,d.getContext("2d").drawImage(l,0,0,u,p),d.toBlob(s=>{s?(console.log(`Image compressed: ${(t.size/1024).toFixed(1)}KB ‚Üí ${(s.size/1024).toFixed(1)}KB`),a(s)):o(new Error("Image compression failed"))},"image/jpeg",n)},l.onerror=o},i.onerror=o})}async function H(t,e){try{const n=await fetch("/api/analyze",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({image:t,mimeType:e,language:r.language})});if(!n.ok){const a=await n.text();throw console.error("API Error Response:",a),new Error(`API request failed (${n.status}): ${a}`)}return await n.json()}catch(n){throw console.error("analyzeWithAPI error:",n),n}}function M(t){F.textContent=t.item,x.querySelector(".choice-label").textContent=t.option1.label,C.querySelector(".choice-label").textContent=t.option2.label,h("choice")}async function T(t){const e=r.pendingAnalysis,n=t===1?e.option1:e.option2,a=t===1;r.detectedCategory=n.category;let o=n.search_term;o&&(o=o.replace(/(https?:\/\/)?(www\.)?/gi,"").replace(/\.(com|vn|net|org|edu|gov)(\.vn)?/gi,"").trim()),h("loading");const{latitude:i,longitude:c}=r.userLocation,l=document.getElementById("debug-coords");l&&(l.innerText=`Lat: ${i.toFixed(5)}, Lng: ${c.toFixed(5)}`),r.actualSearchTerm=o||"G√©n√©rique";const d=await V(i,c,n.category,e.item,o,a);r.results=d.results||[],r.fallbackInfo=d.fallbackInfo,A(),h("results")}x.addEventListener("click",()=>T(1));C.addEventListener("click",()=>T(2));async function V(t,e,n,a,o,i){try{const c={latitude:t,longitude:e,category:n,radius:5e4};i&&o&&o.length>2&&(c.query=o);const l=await fetch("/api/search-places",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(c)});if(!l.ok){const s=await l.text();throw console.error("Search API Error:",s),new Error(`Search failed (${l.status}): ${s}`)}const d=await l.json();if(!d.results||d.results.length===0)return[];const u={tier:d.fallback_tier||1,message:d.fallback_message};return{results:d.results.map(s=>({id:s.id,name:s.name,category:s.category,address:s.address,image:`https://source.unsplash.com/200x200/?${encodeURIComponent(n)}&sig=${s.id}`,price:s.price,distance:s.distance,lat:s.lat,lng:s.lng})).sort((s,z)=>s.distance-z.distance).slice(0,20),fallbackInfo:u}}catch(c){return console.error("Search error:",c),[]}}function j(){return console.log("Requesting geolocation..."),new Promise((t,e)=>{if(!navigator.geolocation){e(new Error("Geolocation not supported"));return}const n={enableHighAccuracy:!0,timeout:15e3,maximumAge:0};navigator.geolocation.getCurrentPosition(a=>{console.log("Geolocation success (High Accuracy):",a.coords.latitude,a.coords.longitude),t(a)},a=>{console.warn("High accuracy geolocation failed, trying low accuracy...",a),navigator.geolocation.getCurrentPosition(o=>{console.log("Geolocation success (Low Accuracy):",o.coords.latitude,o.coords.longitude),t(o)},o=>{console.error("Geolocation failed completely:",o),e(o)},{enableHighAccuracy:!1,timeout:15e3,maximumAge:0})},n)})}
